# Twilio's Owl Finance Demo
### Learn how to build a production quality contact center

**Degree of Difficulty (1-5): 4** This demo requires knowledge of the C# programming language, SOLID design principles, and the Microsoft .NET stack.

Owl Finance is a fully functioning, fictional, banking contact center. Customers can send text messages, create traditional phone calls, in app voice calls, and send in app chat messages through the contact center. All channels of communication are intelligently routed to an agent with the appropriate skills to handle any request. Take a look at the following video for a high level explanation:

[![Owl Finance Demo](https://github.com/jonedavis/OwlFinance/blob/master/images/youtube.png?raw=true)](https://youtu.be/pSVdTt7zJh8)

The following technologies and frameworks are used in Owl Finance:

1. Twilio Services
    1. TaskRouter (Vendor-agnostic API for intelligent task routing)
    2. Programmable SMS (Send notifications of fraudulent transactions)
    3. Programmable Chat (Text based chat service for agent and customer)
    4. Programmable Phone Number (Agent assigned phone number for WebRTC calls)
    5. Programmable Video (In app voice calls using the audio channel of video sdk)
2. Microsoft Azure (Web, Server, and Blob Storage Hosting)
3. Xamarin.iOS (Mobile Client)
    * [Twilio IP Messaging NuGet](https://www.nuget.org/packages/Twilio.IPMessaging.Xamarin/) 
    * [Twilio Rooms SDK for In App Audio NuGet](https://www.nuget.org/packages/Twilio.Rooms.Xamarin/1.0.0-beta3-2)
4. ASP.NET (Web and Server APIs)
5. Auth0 (Authentication Service)
6. AngularJS (Web Client)
7. DocuSign (Push a real-time dynamically generated document from the agent to customer in app)
8. DarkSky (Get weather by zipcode)
9. Zipcode API (Determine geographical location based off zipcode)

## Required URLs And IDs To Update

### Web API Project

#### Web.config
All API keys are stored in `api/website/TwilioOwlFinanceApi/web.config`

**Note:** Your Twilio API Secrets will only be shown once. Make sure to save them in a secure location when you generate an API key pair.

External Service/Key | Description
---------- | -----------
[hockeyApp:AppId](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L12) | This is the AppID generated by HockeyApp. Used for beta app distribution. Email sent when accounts created. You can [signup here.](https://www.hockeyapp.net/) (Optional)
[hockeyApp:Secret](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L13) | This is the Secret generated by HockeyApp. Used for beta app distribution. Email sent when accounts created. You can [signup here.](https://www.hockeyapp.net/) (Optional)
[auth0:ClientID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L14) | Auth0 genereated Client ID. Auth0 is a Login provider. You can [signup here.](https://auth0.com/)
[auth0:ClientSecret](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L15) | Auth0 generated secret key.
[auth0:AuthToken](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L14) | Auth0 generated authentication token.
[auth0:Domain](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L14) | Auth0 genereated subdomain.
[storage:BaseURL](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L14) | Azure Blog Storage to store profile pictures. Create a blob storage account and create a container named `images`. Then upload your profile pictures to that container. Click here to learn more about [Azure Blog Storage](https://docs.microsoft.com/en-us/azure/storage/storage-dotnet-how-to-use-blobs).
[twilio:AuthToken](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L20) |  Your main Twilio account authentication token. - [find it on your dashboard.](https://www.twilio.com/console)
[twilio:AccountSID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L20) |  Your main Twilio account SID. - [find it on your dashboard.](https://www.twilio.com/console)
[Twilio TaskRouter SIDs](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L22) | Used to create cases. Needed: WorkspaceSID, WorkflowSID, OfflineActivitySID, IdleActivitySID, BusyActivitySID, ReservedActivitySID. See **Helpful Links** below for more information. - [generate them here.](https://www.twilio.com/console/taskrouter/dashboard)
[twilio:ApiKey](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L28) | Used to authenticate - [generate one here.](https://www.twilio.com/user/account/messaging/dev-tools/api-keys)
[twilio:ApiSecret](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L29) | Used to authenticate - [get one here.](https://www.twilio.com/user/account/messaging/dev-tools/api-keys)
[twilio:IpMessagingSID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L30) | Like a database for your Chat data - [generate one here.](https://www.twilio.com/console/chat/services)
[twilio:ConversationsSID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L31) | Adds video capability to the access token - [generate one here.](https://www.twilio.com/user/account/video/profiles)
[twilio:FromPhoneNumber](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L32) | Used to initiate PSTN call from Agent to Customer - [get one here.](https://www.twilio.com/console/phone-numbers/search)
[twilio:AppSID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L33) | An application SID is the way that a Twilio application is identified. An application is a container for a set of URLs and configurations that you can use for a phone number or a group of phone numbers. - [generate one here.](https://www.twilio.com/console/voice/dev-tools/twiml-apps)
[weather:ApiKey](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L35) | Get Weather based off zipcode - [signup here.](https://api.darksky.net)
[zipcode:ApiKey](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L37) | Zipcode API to determine location - [signup here.](https://www.zipcodeapi.com)
[docusign:UserName](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L38) | This is your username used to login to DocuSign. To send certified documents to Customers - [signup here.](https://www.docusign.com/developer-center)
[docusign:Password](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L39) | This is your password used to login to DocuSign. [signup here.](https://www.docusign.com/developer-center)
[docusign:IntegratorKey](https://github.com/jonedavis/TwilioOwlFinance/blob/master/api/website/TwilioOwlFinanceApi/Web.config#L40) | This generated API Key from DocuSign. [signup here.](https://www.docusign.com/developer-center)

**Note:** You will need 2 ngrok tunnels to run Owl Finance locally. Set ngrok tunnels in `web/website/web.config`. You can [download ngrok here.](https://ngrok.com/download)

#### Account Creation
Name | Description
---------- | -----------
[HockeyApp Email](https://github.com/jonedavis/TwilioOwlFinance/blob/3f0b623c12eb1ff87dca110bf7f6edc0768a9c33/api/projects/Twilio.OwlFinance.Services/AdminService.cs#L335) | An autogenerated email sent the new user from HockeyApp.

### Website Project
Name | Description
---------- | -----------
[API Base URL](https://github.com/jonedavis/TwilioOwlFinance/blob/master/web/website/Web.config#L4) | Base URL to Web API Project
[SignalR URL](https://github.com/jonedavis/TwilioOwlFinance/blob/master/web/website/Web.config#L5) | Base URL to this website project for SignalR
[SignalR Hubs](https://github.com/jonedavis/TwilioOwlFinance/blob/master/web/website/Web.config#L6) | URL to this website project for the SignalR Hubs
[Auth0 Client ID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/web/website/app/app.auth0-variables.js#L2) | Development Build AngularJS ClientID
[Auth0 Domain](https://github.com/jonedavis/TwilioOwlFinance/blob/master/web/website/app/app.auth0-variables.js#L3) | Development Build Auth0 sub domain
[Auth0 Client ID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/web/website/app/app.auth0-variables.js#L2) | Production Build AngularJS ClientID. This can be the same as the Development build.
[Auth0 Domain](https://github.com/jonedavis/TwilioOwlFinance/blob/master/web/website/app/app.auth0-variables.js#L3) | Production Build Auth0 sub domain. This can be the same as the Development build.

### Mobile Project
Name | Description
---------- | -----------
[ApiBaseUri](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/projects/Twilio.OwlFinance.Domain/OwlFinanceUris.cs#L5) | Base URL for API
[SignalR Path](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/projects/Twilio.OwlFinance.Domain/OwlFinanceUris.cs#L6) | Base URL for SignalR
[HockeyAPP ID](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/apps/iOS/OwlFinance/OwlFinance/AppDelegate.cs#L65) | Used to log data such as crashes into HockeyApp
[Auth0Login](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/apps/iOS/OwlFinance/OwlFinance/Helpers/EnvironmentConstants.cs#L5) | URL Generated by Auth0 e.g. twilio-owl-finance.auth0.com
[Auth0Password](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/apps/iOS/OwlFinance/OwlFinance/Helpers/EnvironmentConstants.cs#L6) | Auth0 Generated Security Key/Password
[Auth0Secret](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/apps/iOS/OwlFinance/OwlFinance/Helpers/EnvironmentConstants.cs#L7) | Auth0 Generated Secrete
[AzureNotificationHub](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/apps/iOS/OwlFinance/OwlFinance/Helpers/EnvironmentConstants.cs#L8) | Azure Notification Hub for Apple Push Notifications
[AzureNamespace](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/apps/iOS/OwlFinance/OwlFinance/Helpers/EnvironmentConstants.cs#L9) | Azure Namespace for Apple Push Notifications
[AzurePushAccess](https://github.com/jonedavis/TwilioOwlFinance/blob/master/mobile/apps/iOS/OwlFinance/OwlFinance/Helpers/EnvironmentConstants.cs#L10) | Azure Push Notification Access Key

##  First Run: Seeding The Database
You'll need to seed the database with customer information: addresses, accounts, (fake) credit card numbers, merchants, statements, and transactions. This is all done for you.

Name | Description
---------- | -----------
[Development Seed Data IdentityID](https://github.com/jonedavis/TwilioOwlFinance/blob/3f0b623c12eb1ff87dca110bf7f6edc0768a9c33/api/projects/Twilio.OwlFinance.Infrastructure.DataAccess/Configuration/Database/SeedData/DevelopmentData.cs#L77) | You will need to update the Auth0 ID you created for your account. You are specifically looking to update every instance of `IdentityID`. There are three customers and three agents provided for you. You only need one customer and one agent to run the app. Moving forward you can use the Account Creation API below to create more customers and agents. Search for `IDENTITY-ID-HERE`
[Production Seed Data IdentityID](https://github.com/jonedavis/TwilioOwlFinance/blob/3f0b623c12eb1ff87dca110bf7f6edc0768a9c33/api/projects/Twilio.OwlFinance.Infrastructure.DataAccess/Configuration/Database/SeedData/ProductionData.cs#L85) | Same as above. Search for `IDENTITY-ID-HERE`
[Development Seed Data WorkerSID](https://github.com/jonedavis/TwilioOwlFinance/blob/3f0b623c12eb1ff87dca110bf7f6edc0768a9c33/api/projects/Twilio.OwlFinance.Infrastructure.DataAccess/Configuration/Database/SeedData/DevelopmentData.cs#L88) | A TaskRouter [Worker](https://www.twilio.com/docs/api/taskrouter/workers) is also required. A Worker represent an entity that is able to perform tasks, such as an agent working in a call center, or a salesperson handling leads. Task are how Agent/Customer interactions take place. Go to your [Twilio TaskRouter Workspace](https://www.twilio.com/console/taskrouter/workspaces), select Workers, and click the red + button to create a new Worker. A SID will generate for you after you save the Worker. Search for `WORKER-SID-HERE`
[Production Seed Data WorkerSID](https://github.com/jonedavis/TwilioOwlFinance/blob/3f0b623c12eb1ff87dca110bf7f6edc0768a9c33/api/projects/Twilio.OwlFinance.Infrastructure.DataAccess/Configuration/Database/SeedData/ProductionData.cs#L88) | Same as above. Search for `WORKER-SID-HERE`

## Deploying to Azure
Need help deploying to Azure? Microsoft has great [documentation](https://docs.microsoft.com/en-us/azure/app-service-web/web-sites-dotnet-get-started#create-the-azure-resources) to help you through the process.

## Create New Customer & Agent Accounts
For demoing purposes, Customer and Agent accounts are paired together. This guarantees that when multiple people run the demo at the same time, the incoming request goes to the correct account. This feature can be undone in the Twilio TaskRouter console. Removing the Routing Configuration Attributes will open up task assignments to any Agent that is available to accept the task.

Update `CreateAgentAsync(CreateAgentRequest)` in `api/projects/Twilio.OwlFinance.Services/AdminService.cs` if you want to send an email to the supplied email address with login information and a HockeyApp download link if this is used for beta distribution.

 Endpoint | Description
---------- | -----------
`https://YOUR-API-URL-HERE/api/admin/agent` | This endpoint is on the TwilioOwlFinanceAPI project.

### Required Attributes For Account Creation

Attribute | Description
---------- | -----------
`Email` | An email address to link to this account. 2 Accounts will be created: YourEmail+Agent@ and YourEmail+Customer@
`FirstName` | First name
`LastName` | Last name
`Password` | Password shared for both Customer and Agent accounts.
`PhoneNumber` | Phone number for customer for PSTN feature.

Creating an agent with this endpoint and required attributes will create a linked Customer account seeded with transaction data.


## High-level Technical Walk-through
The application is built with a decoupled architecture in mind. Below is an architectural diagram that will jumpstart your understanding of how the different Lego pieces of the application fit together:

![Owl Finance Architecture Diagram](https://github.com/jonedavis/OwlFinance/blob/master/images/owlfinance-arch.jpg?raw=true)

All the interactions for both the mobile and web client go through a set of APIs. The APIs acts as central hub for allowing the necessary service integrations with third party providers such as Twilio, DarkSky API (previously known as Forecast), ZipcodeAPI, DocuSign, and Auth0. 

#### 1. Agent Portal
All web assets are hosted on Azure services and the agent portal is built with AngularJS (1.4.x). When Auth0’s SDK, for JWT based authentication and authorization, is invoked the agent generates a token that is passed to the APIs to get any available data when the agent logs in.
#### 2. Authentication / Authorization
APIs use Auth0’s SDK to validate the JWT token and start serving the requests to the portal.
#### 3. Mobile App
The customer downloads the mobile app and logs in. Auth0’s SDK are again used to validate and generate a JWT token which is sent to the API to be validated and serve any requests. 
#### 4. Agent Sends "Fraudulent" SMS
Customer receives alert with deeplink about a "fraudulent" transaction. The customer clicks the link, the mobile app opens, and the customer attempts to reach out to an agent.
#### 5. Twilio TaskRouter
TaskRouter communicates the request to the Twilio TaskRouter engine. A task is created with using the C# helper libraries. TaskRouter then looks at the request and assigns it to an available agent based on the skills that are defined and required by the customer's request.
#### 6. Agent Portal
The matched agent receives a notification to start interacting with the customer using the TaskRouter's worker.js library.
#### 7. Twilio Programmable Chat
The customer and the agent now communicate via a secure Programmable Chat channel which is used to send text based message back and forth.
#### 8. Twilio Programmable Voice & Video
The agent has the option to chat with the customer in the mobile app or by traditional phone lines. Accepting an in app chat displays a swipeable conversation widget on top of the customer's mobile app.
#### 9. DocuSign
The agent then sends a DocuSign using pub/sub events to the customer. The customer signs the document and the agent can view the signature.
#### 10. Finished
The agent can close the case, continue to conversate with the customer, or view past customer/agent interactions.

## Code Architecture
The entire app, mobile and web client, follow a pattern called “Onion Architecture”. Onion architecture is a software design pattern that “layers” the application using bunch of lego pieces.

![Owl Finance Architecture Diagram](https://github.com/jonedavis/OwlFinance/blob/master/images/onion-arch.png?raw=true)
> http://jeffreypalermo.com/blog/the-onion-architecture-part-1/

Both the mobile and web client are built with maximum reusability and dependency injection in mind. The core part of the architecture contains the domain objects which define the model and contracts of the entire application. There are a bunch of Domain Services, also called infrastructure to take care of HTTP request, database interaction, logging, messaging interaction, and Docusign Services. These layers are then wrapped using a façade called Application Services which is the single point of entry for the mobile and web projects. All of the application follows a strict “new is glue” principal and only feeds dependencies via constructors and dependency injection.
### Helpful Links
1. [Twilio](https://www.twilio.com)
    * [Console](https://www.twilio.com/console)
    * [TaskRouter](https://www.twilio.com/console/taskrouter/dashboard)
      * [Workspaces](https://www.twilio.com/console/taskrouter/workspaces)
        * TaskQueue 
            * https://www.twilio.com/console/taskrouter/workspaces/{WS--YOURID}/taskqueues
        * Workflow
            * https://www.twilio.com/console/taskrouter/workspaces/{WS--YOURID}/workflows
        * Workers
            * https://www.twilio.com/console/taskrouter/workspaces/{WS--YOURID}/workers 
        * Tasks
            * https://www.twilio.com/console/taskrouter/workspaces/{WS15--YOURID}/tasks
    * [Twilio Phone Number](https://www.twilio.com/console/phone-numbers/incoming)
    * [IP Messaging](https://www.twilio.com/console/ip-messaging/dashboard)
    * A Programmable Chat (formerly known as IP Messaging) Service
        * https://www.twilio.com/console/chat/services/{IS--YOURID}
    * [Programmable Video](https://www.twilio.com/console/video/dashboard)
    * [Programmable Voice](https://www.twilio.com/console/voice/dashboard)
    * [Programmable SMS](https://www.twilio.com/console/sms/dashboard)
2. Azure
    * [Azure Portal](https://portal.azure.com/)
    * [App Services](https://portal.azure.com/#blade/HubsExtension/Resources/resourceType/Microsoft.Web%2Fsites)
      * For both APIs and Web Interface
   * [SQL Server Database](https://portal.azure.com/#blade/HubsExtension/Resources/resourceType/Microsoft.Sql%2Fservers%2Fdatabases)
   * [A Storage Account](https://portal.azure.com/#blade/HubsExtension/Resources/resourceType/Microsoft.Storage%2FStorageAccounts)
     * For Assets
3. [Xamarin](https://www.xamarin.com)
   * Build mobile apps in a single shared codebase in C# and .NET
   * iOS Mobile Client.
4. [Auth0](https://auth0.com/)
   * A [Client](https://manage.auth0.com/#/clients) with Auth0
5. [DarkSky](https://darksky.net/dev/)
6. [Zipcodeapi](https://www.zipcodeapi.com/)

## Additional Resources
- [Microsoft Azure Account](https://azure.microsoft.com/en-us/services/functions/)
- Windows
 - [Visual Studio for Windows](https://www.visualstudio.com/downloads/)
 - [Azure .NET SDK](https://go.microsoft.com/fwlink/?LinkId=518003&clcid=0x409)
- Mac
 - [Xamarin Studio Community](https://www.xamarin.com/download)
 - [Visual Studio Code](https://code.visualstudio.com/)
 - [Azure Functions CLI](https://www.npmjs.com/package/azure-functions-cli)
 
## Contributors
1. [Jon Davis](https://github.com/jonedavis)
   * Design, Development, and Xamarin Bindings
2. [Falafel](http://www.falafel.com)
   * Development
3. [Michael Davis](https://github.com/michaeled)
   * Agent and Customer Account Creation Automation
4. [Colby Williams](https://github.com/colbylwilliams)
   * SWRevealViewController Binding and bug fixes.
5. [Impekable](http://www.impekable.com)
